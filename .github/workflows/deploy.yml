name: Deploy to Aliyun

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Build Docker image
        run: |
          docker build -t go-blog:latest .
          docker save go-blog:latest -o go-blog.tar
          ls -lh go-blog.tar

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Transfer files to server
        run: |
          scp -i ~/.ssh/id_rsa go-blog.tar docker-compose.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/root/go-blog/

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd /root/go-blog
            docker load -i go-blog.tar
            docker-compose down
            docker-compose up -d
            docker system prune -f
            rm go-blog.tar
          EOF
